# elasticsearch 使用规范

## 命名规范

- 索引名和字段名只能包括字母、数字、下划线、中划线，统一小写，字母开头，禁止使用下划线开头，禁止包含特殊字符
- 索引名需要能清晰地标识对应的业务

## 使用规范

- 分片数量设置为偶数，合理分片数量 = 索引主分片大小(不包含副本) / 30G，控制单个分片大小不超过 30GB，单个索引不超过 50 个分片
- 索引映射一律设置严格模式，不允许自动匹配数据创建字段，否则可能会出现时间数据和字符串之间匹配出错导致后期数据插入失败
- 时间类型字段必须严格插入标准的时间格式数据，不允许出现 '0000-00-00 00:00:00'，可以使用 '1970-01-01 00:00:00'
- 禁止将图片、二进制、大型文章存入 ES，这类数据考虑使用对象存储，ES中存储对应的链接地址，单字段限制 1000 个字符，单个索引所有字段限制 3000 个字符
- 如果 ES 用于辅助 DB 搜索，那么 ES 只存储查询所用到的必要字段，其它相关字段信息可以使用 id 到 DB 去获取
- 对于需要搜索文章类的场景，整篇文章存储对象存储中，ES 存储文章的指定关键字和整篇文章前面几百个字符做分词检索获取到文章对应链接
- ES 只支持快照备份，不支持时间点回滚，集群出现异常有可能会丢失数据，不允许数据丢失的场景避免使用 ES
- ES 不支持事务，对于数据一致性有要求的场景避免使用 ES
- 禁止进行多重嵌套、多维度的聚合统计分析查询，特别是对大的结果集进行聚合统计分析，会导致 ES 节点有 OOM 的风险，禁止将 ES 用作报表分析场景
- ES 默认对于数值字段建立 BKDTree 索引，但是倒排索引能够最大发挥 Lucene 的查询性能。所以对于有限枚举值的数值字段（例如：状态字段），建议使用 keyword 类型以创建倒排索引。如果使用数字类型进行查询时，ES 会使用范围扫描进行搜索，查询性能极差。
- 禁止代码做主动刷新，默认索引每隔1秒会进行一次刷新，刷新会产生新的段并且会导致频繁的合并，这些行为对集群性能影响极大
- 使用 `search_after` 遍历数据时，禁止使用 `_id` 做游标排序字段，应使用 int，date，keyword 等有顺序的字段类型的字段做排序字段
