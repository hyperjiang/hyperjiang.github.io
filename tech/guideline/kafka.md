# kafka 使用规范

## 命名规范

1. topic名、消费组命名，名字里面只能包括字母、数字、下划线，**且统一小写，字母开头**
2. topic名、消费组名由“**业务名_业务标识**”组成，例如：sms_sending(短信通知)
3. 禁止使用过于简单容易冲突的名字，例如：msg

## 生产规范和参数配置

1. 单条消息最大: 1M(1000*1000bytes)，单条消息控制在10kb以内
2. request.required.acks: 没有特殊要求统一配成1(保证leader写入成功即可)，配置all(所有副本接收到消息)会导致生产超时同时qps会很差
3. 控制每秒写入和消费的速度避免瞬时流量影响服务器性能，控制每秒生产qps低于5万(已知特殊量大的topic除外)
4. 生产不能指定分区，会导致分区数据不均衡导致存储不均衡同时也会影响消费性能
5. 生产参数必须设置client.id，否则无法做应急限流，生产client.id使用topic名

### Producer参数

| **参数**             | **默认值** | **推荐值**       | **说明**                                                     |
| -------------------- | ---------- | ---------------- | ------------------------------------------------------------ |
| acks                 | 1          | 1                | 收到server端确认信号个数，表示procuder需要收到多少个这样的确认信号，算消息发送成功。acks参数代表了数据备份的可用性。acks=**0**：表示producer不需要等待任何确认收到的信息，副本将立即加到socket buffer并认为已经发送。没有任何保障可以保证此种情况下server已经成功接收数据，同时重试配置不会发生作用（因为客户端不知道是否失败）回馈的offset会总是设置为-1。 acks=**1**：这意味着至少要等待leader已经成功将数据写入本地log，但是并没有等待所有follower是否成功写入。如果follower没有成功备份数据，而此时leader又无法提供服务，则消息会丢失。 acks=**all**：这意味着leader需要等待所有备份都成功写入日志，只有任何一个备份存活，数据都不会丢失。 |
| retries              | 0          | 结合实际业务调整 | 客户端发送消息的重试次数。值大于0时，这些数据发送失败后，客户端会重新发送。 注意，这些重试与客户端接收到发送错误时的重试没有什么不同。允许重试将潜在的改变数据的顺序，如果这两个消息记录都是发送到同一个partition，则第一个消息失败第二个发送成功，则第二条消息会比第一条消息出现要早。 |
| request.timeout.ms   | 30000      | 结合实际业务调整 | 设置一个请求最大等待时间，超过这个时间则会抛timeout异常。 超时时间如果设置大一些，如120000（120秒），高并发的场景中，能减少发送失败的情况。 |
| block.on.buffer.full | TRUE       | TRUE             | true表示当我们内存用尽时，停止接收新消息记录或者抛出错误。 默认情况下，这个设置为true。然而某些阻塞可能不值得期待，因此立即抛出错误更好。如果设置为false，则producer抛出一个异常错误：BufferExhaustedException |
| batch.size           | 16384      | 262144           | 每个batch要存放多少数据就可以发送出去了，默认16KB，因为理论上来说，提升batch的大小，可以允许更多的数据缓冲在里面，那么一次request发送出去的数据量就更多了，这样吞吐量可能会有所提升。producer将试图批处理消息记录，以减少请求次数，这将改善client与server之间的性能。 发送到brokers的请求将包含多个批量处理，其中会包含对每个partition的一个请求。 较小的批量处理数值比较少用，并且可能降低吞吐量（0则会禁用批量处理）。较大的批量处理数值将会浪费更多内存空间。 |
| linger.ms            | 0          | 100              | 一条/批次消息最长等待发送时间，该参数和batch.size配合使用当达到一个批次大小时/达到最长发送时间时就会立即发送到broker，但是在消息比较少的情况下会导致写入延时。 |
| buffer.memory        | 33554432   | 67108864         | producer可以用来缓存数据的内存大小。如果数据产生速度大于向broker发送的速度，producer会阻塞或者抛出异常，由block.on.buffer.full控制。 这项设置将和producer能够使用的总内存相关，但并不是一个硬性的限制，因为不是producer使用的所有内存都是用于缓存。一些额外的内存会用于压缩（如果引入压缩机制），同样还有一些用于维护请求。 |
| client.id            |            |                  | 客户端id                                                     |

*注意：设置batch.size和linger.ms可以在高吞吐量的场景提升性能，但是同样会带来在低吞吐量的场景下的延时，需要根据业务实际场景做调整。*

## 消费规范和参数配置

1. 默认消费组的offset保留1天，如果消费者进程挂了1天没重启历史offset消费记录会被清除
2. 避免一个服务同时消费多个topic，特别是异步线程处理容易出现OOM
3. 一个消费组的消费进程至少起到两台以上的机器上面，保证高可用
4. 消费参数必须设置group.id和client.id，否则无法做应急限流，消费client.id使用消费组名

### Consumer参数

| **参数**                | **默认值** | **推荐值** | **说明**                                                     |
| ----------------------- | ---------- | ---------- | ------------------------------------------------------------ |
| auto.commit.enable      | TRUE       | FALSE      | 如果为true，consumer所fetch的消息的offset将会自动的同步到zookeeper。这项提交的offset将在进程无法提供服务时，由新的consumer使用。 约束：设置为false后，需要先成功消费再提交，这样可以避免消息丢失。如果要开启消费位点自动提交，参数配置参考：`enable.auto.commit：默认值为true； auto.commit.interval.ms：默认值为1000，即1s` |
| auto.offset.reset       | latest     | latest     | 没有初始化offset或者offset被删除时，可以设置以下值： earliest：自动复位offset为最早；latest：自动复位offset为最新；none：如果没有发现offset则向消费者抛出异常；anything else：向消费者抛出异常。 |
| heartbeat.interval.ms   | 3000       | 3000       | 消费进程和消费组之间维持心跳的时长，值必须设置为低于session.timeout.ms，但通常应设置为不高于该值的1/3。它可以调整得更低，以控制正常再平衡的预期时间。 |
| session.timeout.ms      | 10000      | 10000      | 用于判断消费消费进程是否活跃，如果消费进程超出改参数设置的时长还未发送心跳broker就认为该消费进程已不活跃，该消费进程就会被移出消费组重新进行rebalance，注意：参数设置的范围必须是在group.min.session.timeout.ms（默认6s）和group.max.session.timeout.ms（默认30s）之间 |
| connections.max.idle.ms | 600000     | 30000      | 空连接的超时时间，设置为30000可以在网络异常场景下减少请求卡顿的时间。 |
| group.id                |            |            | 配置消费组                                                   |
| client.id               |            |            | 客户端id                                                     |
